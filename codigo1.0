#include <Wire.h> // Librería para comunicación I2C
#include <Adafruit_MPU6050.h> // Librería del sensor MPU-6050
#include <Adafruit_Sensor.h> // Librería base de Adafruit para sensores
#include <BleMouse.h>

BleMouse bleMouse("ESP32 Mouse", "ESP32", 100);
Adafruit_MPU6050 mpu;
const int VRX_PIN = 34;
const int VRY_PIN = 35;

void setup() {
  // 1. Iniciar la comunicación serial a alta velocidad (¡Asegúrate de usar 115200 en el Monitor Serial!)
  Serial.begin(115200); 
  bleMouse.begin();
  pinMode(23, OUTPUT);
  pinMode(15  , INPUT_PULLUP);
  pinMode(10, INPUT_PULLUP);
  pinMode(9, INPUT_PULLUP);
  pinMode(10, INPUT_PULLUP);


  // 2. Inicialización del MPU-6050
  Serial.println("Inicializando MPU-6050...");

  // Intenta comenzar la comunicación con el sensor en la dirección I2C por defecto (0x68).
  // Si falla, el programa se detiene.
  if (!mpu.begin()) {
    Serial.println("❌ ERROR: Fallo al encontrar el chip MPU-6050. Verifica las conexiones.");
    Serial.println("Asegúrate que SDA=GPIO 21 y SCL=GPIO 22 y VCC=3V3.");
    // Detiene el programa aquí
    while (1) {
      delay(100); 
    }
  }
  Serial.println("✅ MPU-6050 Encontrado y Listo!");

  // Configuración de los rangos del sensor (opcional, pero recomendado)
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G); 
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);     
  mpu.setFilterBandwidth(MPU6050_BAND_21_HZ);  
}

void loop() {
  int x = digitalRead(10);
  int y = digitalRead(9);
  int z  = digitalRead( 15);
  static int l = 0; //cambia de girosc a joystick
  static int m = 0; //contador click
  static int k = 0; //solo clickear 1 ves
  int xValue = analogRead(VRX_PIN);
  int yValue = analogRead(VRY_PIN);
  digitalWrite(23, HIGH); 
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

xValue = xValue-2850;
yValue = yValue-2850;
if(xValue < 0){
  xValue = xValue/2.289;}
if(yValue < 0){
  yValue = yValue/2.289;}
  
 if(xValue == 1245 && yValue == 1245){
  xValue = 0;
  yValue = 0;}

if(g.gyro.x < 0){
    if(g.gyro.x >= -0.15){
     g.gyro.x = 0;}}
if(xValue/20.73 < 0){
    if(xValue/20.73 >= -5){
     xValue = 0;}}
if(yValue/20.73 < 0){
    if(yValue/20.73 >= -5){
     yValue = 0;}}


if (y == 0) { 
  l = (l-1);
  l = l*l;
  delay(600);}
if (l == 0) {
bleMouse.move(-g.gyro.z*40,-g.gyro.x*40,-yValue/1000,xValue/1000);}
if (l == 1) {
bleMouse.move(xValue/207.3,yValue/207.3);}
if (x == 0) {
m = m+1;


if(m > 7){
bleMouse.press();
}}


if (x != 0) {
if(m < 7){
if(m !=0){
if(k == 0){
bleMouse.click();
k = 1;}}}


m = 0;
k = 0;
bleMouse.release();}
Serial.print(k);
Serial.println(m);

if (z == 0) {bleMouse.click(MOUSE_RIGHT);
delay(600);}




  delay(30); // Pausa para no saturar el puerto serial
}
