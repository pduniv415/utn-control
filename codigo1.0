#include <Wire.h> // Librería para comunicación I2C
#include <Adafruit_MPU6050.h> // Librería del sensor MPU-6050
#include <Adafruit_Sensor.h> // Librería base de Adafruit para sensores
#include <BleMouse.h>

BleMouse bleMouse("ESP32 Mouse", "ESP32", 100);
Adafruit_MPU6050 mpu;
const int VRX_PIN = 34;
const int VRY_PIN = 35;

void setup() {
  // 1. Iniciar la comunicación serial a alta velocidad (¡Asegúrate de usar 115200 en el Monitor Serial!)
  Serial.begin(115200); 
  bleMouse.begin();
  pinMode(23, OUTPUT);

  // 2. Inicialización del MPU-6050
  Serial.println("Inicializando MPU-6050...");

  // Intenta comenzar la comunicación con el sensor en la dirección I2C por defecto (0x68).
  // Si falla, el programa se detiene.
  if (!mpu.begin()) {
    Serial.println("❌ ERROR: Fallo al encontrar el chip MPU-6050. Verifica las conexiones.");
    Serial.println("Asegúrate que SDA=GPIO 21 y SCL=GPIO 22 y VCC=3V3.");
    // Detiene el programa aquí
    while (1) {
      delay(100); 
    }
  }
  Serial.println("✅ MPU-6050 Encontrado y Listo!");

  // Configuración de los rangos del sensor (opcional, pero recomendado)
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G); 
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);     
  mpu.setFilterBandwidth(MPU6050_BAND_21_HZ);  
}

void loop() {

  int xValue = analogRead(VRX_PIN);
  int yValue = analogRead(VRY_PIN);
  digitalWrite(23, HIGH); 
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

xValue = xValue-2850;
yValue = yValue-2850;
if(xValue < 0){
  xValue = xValue/2.289;}
if(yValue < 0){
  yValue = yValue/2.289;}
  
 if(xValue == 1245 && yValue == 1245){
  xValue = 0;
  yValue = 0;}

  //Serial.print("X: ");
  Serial.print(xValue/20.73);
  //Serial.print(" | Y: ");
  Serial.println(yValue/20.73);
  //Serial.print("X: ");
  Serial.print(a.acceleration.x, 1); 
  //Serial.print("  Y_: ");
  Serial.println(a.acceleration.y, 1);
  Serial.print(g.gyro.x,1);
  Serial.println(g.gyro.y, 1);


/*if(a.acceleration.x < 0.8 ||){a.acceleration.x = 0;}
if(a.acceleration.y < 0.8 ||a.acceleration.x > -0.8 ){a.acceleration.y = 0;}*/


bleMouse.move(-g.gyro.z*50,-g.gyro.x*30);
//bleMouse.move(-a.acceleration.x*3 ,0);


  delay(30); // Pausa para no saturar el puerto serial
}




